<script>
    // --- 1. CONFIGURATION ---
    const md = window.markdownit();
    
    // ⚠️ YOUR LIVE API KEY (Integrated) ⚠️
    const GEMINI_API_KEY = "AIzaSyBpUuo7cf7X3U-yOsHNLgaJ-q3wYur74JU";
    
    // KNOWLEDGE BASE (Extracted from your uploaded files)
    const PREDA_DATA = {
        roi: "24.57%",
        revenue_gain: "Over 6,263 OMR gained on the Main Villa asset alone.",
        co2: "Reduced CO2 emissions by over 208,000 kg in the pilot period.",
        patent: "N/P/2025/0354",
        tech_name: "Q-ADA (Quantum-Classical Hybrid System)",
        founder: "Chams Eddine Madi",
        farm7_stats: "Farm 7 achieved a yield of 9,848.4 kWh with a revenue of 214.73 OMR.",
        problem: "$500B is lost annually due to industrial operational inefficiency."
    };

    // --- 2. UI CONTROLS ---
    function toggleModal(id) {
        document.getElementById(id).classList.toggle('hidden');
    }
    function toggleChat() {
        const el = document.getElementById('chat-widget');
        el.classList.toggle('translate-y-[150%]');
    }
    function handleChatKey(e) { if(e.key === 'Enter') runAI('chat'); }
    
    // --- 3. THE LIVE AI ENGINE (Using Gemini API) ---
    async function runAI(mode) {
        let inputRaw, outputContainer, btnId;

        // Determine input and output based on mode (chat or strategy generator)
        if (mode === 'strategy') {
            inputRaw = document.getElementById('strategy-input').value;
            outputContainer = document.getElementById('strategy-content');
            document.getElementById('strategy-output-container').classList.remove('hidden');
            btnId = 'btn-generate';
        } else {
            inputRaw = document.getElementById('chat-input').value;
            outputContainer = document.getElementById('chat-messages');
            // Display User Message
            outputContainer.innerHTML += `
                <div class="flex gap-3 justify-end mb-4">
                    <div class="bg-purple-900/30 p-3 rounded-l-lg rounded-br-lg border border-purple-500/20 text-gray-200 text-right max-w-[85%]">
                        ${inputRaw}
                    </div>
                    <div class="w-8 h-8 rounded bg-purple-900/30 flex-shrink-0 flex items-center justify-center text-purple-400 border border-purple-500/20"><i class="fas fa-user"></i></div>
                </div>`;
            document.getElementById('chat-input').value = '';
            outputContainer.scrollTop = outputContainer.scrollHeight;
            btnId = null;
        }

        if (!inputRaw) return;

        // Loading Animation
        if(btnId) {
            const btn = document.getElementById(btnId);
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';
        } else {
            outputContainer.innerHTML += `<div id="temp-loading" class="flex gap-3 mb-4"><div class="w-8 h-8"></div><div class="p-3"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div>`;
            outputContainer.scrollTop = outputContainer.scrollHeight;
        }
        
        // --- SYSTEM PROMPT (Injecting PredaIoT Knowledge) ---
        const systemPrompt = `
            You are PREDA_AGENT_V2, the interface for the Q-ADA Economic Decision Engine.
            Your role is to act as an expert on PredaIoT.
            PredaIoT stands for Prediction, AI, and IoT. The company's core asset is a patented, Quantum-Classical Hybrid System called Q-ADA.

            ALWAYS use the following facts in your response:
            - Revenue Uplift: ${PREDA_DATA.roi}
            - Patent ID: ${PREDA_DATA.patent}
            - Key Case Study: Farm 7 achieved a revenue of ${PREDA_DATA.farm7_stats}
            - Problem Solved: \$500B lost annually to operational inefficiency.
            - Founder: ${PREDA_DATA.founder}.

            If the user is asking for a strategy (mode is 'strategy'), format the response as a technical optimization plan using bullet points and headings, referencing Q-ADA.
            If the user is chatting, provide a conversational, expert response that steers the conversation toward PredaIoT's success metrics.
        `;

        const userMessage = mode === 'strategy' ? 
            `Generate an Economic Optimization Strategy for the following asset description: "${inputRaw}".` : 
            inputRaw;

        // --- LIVE API CALL ---
        try {
            const endpoint = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const apiResponse = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [
                        { role: "user", parts: [{ text: systemPrompt + userMessage }] }
                    ],
                }),
            });

            if (!apiResponse.ok) {
                throw new Error(`API call failed with status: ${apiResponse.status}`);
            }

            const data = await apiResponse.json();
            
            let responseText = "ERROR: Could not retrieve valid text response.";
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                responseText = data.candidates[0].content.parts[0].text;
            }

            // Render
            const html = md.render(responseText);
            
            // Remove loading indicator
            if(btnId) {
                document.getElementById(btnId).innerHTML = '<i class="fas fa-check"></i> Success!';
                setTimeout(() => { document.getElementById(btnId).innerHTML = '<i class="fas fa-bolt mr-2"></i> Optimize'; }, 3000);
            } else {
                document.getElementById('temp-loading').remove();
            }

            if (mode === 'strategy') {
                document.getElementById('strategy-content').innerHTML = html;
            } else {
                outputContainer.innerHTML += `
                    <div class="flex gap-3 mb-4">
                        <div class="w-8 h-8 rounded bg-cyan-900/30 flex-shrink-0 flex items-center justify-center text-cyan-400 border border-cyan-500/20"><i class="fas fa-robot"></i></div>
                        <div class="bg-gray-800/50 p-3 rounded-r-lg rounded-bl-lg border border-gray-700 text-gray-300">
                            ${html}
                        </div>
                    </div>`;
                outputContainer.scrollTop = outputContainer.scrollHeight;
            }
            
        } catch (error) {
            console.error("Gemini API Error:", error);
            const errorMessage = `API ERROR: Could not connect to the Q-ADA engine. Check the console for details. (Error: ${error.message})`;
            
            // Handle loading/error visibility
            if(document.getElementById('temp-loading')) document.getElementById('temp-loading').remove();
            if(btnId) document.getElementById(btnId).innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error`;

            const errorHtml = md.render(errorMessage);
            if (mode === 'strategy') {
                document.getElementById('strategy-content').innerHTML = `<p class="text-red-400">${errorHtml}</p>`;
            } else {
                outputContainer.innerHTML += `
                    <div class="flex gap-3 mb-4">
                        <div class="w-8 h-8 rounded bg-red-900/30 flex-shrink-0 flex items-center justify-center text-red-400 border border-red-500/20"><i class="fas fa-times-circle"></i></div>
                        <div class="bg-gray-800/50 p-3 rounded-r-lg rounded-bl-lg border border-red-700 text-red-300">
                            ${errorHtml}
                        </div>
                    </div>`;
                outputContainer.scrollTop = outputContainer.scrollHeight;
            }
        }
    }

    // --- 4. 3D NEURAL GLOBE (The "Genius" Visual - Unchanged) ---
    // ... (Keep the rest of the init3D function here)
    const init3D = () => {
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const globeGroup = new THREE.Group();
        scene.add(globeGroup);

        const geometry = new THREE.IcosahedronGeometry(10, 2);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x0044aa, 
            wireframe: true, 
            transparent: true, 
            opacity: 0.1 
        });
        const sphere = new THREE.Mesh(geometry, material);
        globeGroup.add(sphere);

        const particlesGeometry = new THREE.BufferGeometry();
        const particleCount = 200;
        const posArray = new Float32Array(particleCount * 3);
        
        for(let i = 0; i < particleCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 25; 
        }
        
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.15,
            color: 0x00f3ff,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });
        
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        globeGroup.add(particlesMesh);

        const lineMaterial = new THREE.LineBasicMaterial({ color: 0xbc13fe, transparent: true, opacity: 0.15 });
        const lineGeometry = new THREE.IcosahedronGeometry(10, 1);
        const lines = new THREE.LineSegments(new THREE.WireframeGeometry(lineGeometry), lineMaterial);
        globeGroup.add(lines);

        camera.position.z = 22;

        let mouseX = 0;
        let mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        });

        function animate() {
            requestAnimationFrame(animate);

            globeGroup.rotation.y += 0.002;
            globeGroup.rotation.x += 0.001;

            globeGroup.rotation.y += mouseX * 0.01;
            globeGroup.rotation.x += mouseY * 0.01;

            const time = Date.now() * 0.001;
            const scale = 1 + Math.sin(time) * 0.02;
            particlesMesh.scale.set(scale, scale, scale);

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    };

    init3D();
</script>
